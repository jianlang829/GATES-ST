# scripts/run_analysis.py
import os
import yaml
import scanpy as sc
import matplotlib.pyplot as plt
from sklearn.metrics import silhouette_score, davies_bouldin_score
from src.utils import load_and_preprocess_data, Cal_Spatial_Net, Stats_Spatial_Net, Cal_Gene_Similarity_Net, create_pyg_data
from src.gates_model import GATES
from src.trainer import GATESTrainer

def main():
    with open('./configs/default.yaml', 'r', encoding='utf-8') as f:
        config = yaml.safe_load(f)
    print('------------------')
    alpha = config['model']['alpha']
    resolution = config['cluster']['resolution']
    print("Loading and preprocessing data...")
    adata = load_and_preprocess_data(config)
    print(f'After filtering: {adata.shape}')
    print("Building spatial network...")
    Cal_Spatial_Net(adata, rad_cutoff=config['model']['rad_cutoff'], model='Radius', verbose=True)
    Stats_Spatial_Net(adata, save_path=config['output']['neighbor_stats_plot'].format(alpha=alpha, resolution=resolution), show_plot=False)
    print("Building gene similarity network...")
    Cal_Gene_Similarity_Net(adata, k_neighbors=config['model']['k_neighbors'], metric=config['model']['similarity_metric'], verbose=True)
    print("Preparing PyG data...")
    pyg_data = create_pyg_data(adata, config)
    # 确保输入维度正确：高变基因数量
    in_channels = adata.var['highly_variable'].sum() if 'highly_variable' in adata.var else adata.n_vars
    hidden_channels = config['model']['hidden_dims'][0]
    out_channels = config['model']['hidden_dims'][1]
    print(f"Model input dim: {in_channels}, hidden: {hidden_channels}, output: {out_channels}")
    print("Initializing and training GATES model...")
    model = GATES(
        in_channels=in_channels,
        hidden_channels=hidden_channels,
        out_channels=out_channels,
        alpha=alpha
    )
    trainer = GATESTrainer(model, config)
    trainer.train(pyg_data, n_epochs=config['train']['n_epochs'])
    print("Inferring embeddings...")
    embeddings = trainer.infer(pyg_data)
    adata.obsm[config['train']['key_added']] = embeddings
    print("Performing clustering and UMAP...")
    sc.pp.neighbors(adata, use_rep=config['train']['key_added'])
    sc.tl.umap(adata)
    sc.tl.louvain(adata, resolution=resolution)
    louvain_labels = adata.obs['louvain'].astype(int)

    # 修正：使用 GATES 嵌入计算指标，而非 UMAP
    sc_score = silhouette_score(embeddings, louvain_labels)
    db_score = davies_bouldin_score(embeddings, louvain_labels)

    print(f'Silhouette Coefficient: {sc_score:.4f}')
    print(f'Davies-Bouldin Index: {db_score:.4f}')
    print("Generating plots...")
    crop_coord = config['output']['spatial_plot_crop']
    plt.rcParams["figure.figsize"] = (5, 4)
    sc.pl.embedding(adata, basis="spatial", color="louvain", crop_coord=crop_coord, s=6, show=False, title=f'Ours SC{sc_score:.2f} DB{db_score:.2f}')
    plt.axis('off')
    plt.show()

if __name__ == "__main__":
    main()
